/**
 *  Copyright (c) 2025
 *  @Version : 2.2.0
 *  @Author  : https://salarizadi.ir
 *  @Repository : https://github.com/salarizadi/waveform
 *  @Description: A sleek and interactive audio visualization plugin that creates a customizable waveform player with touch support and real-time updates.
 */
!function(t){"use strict";const e=function(){self.onmessage=async function(t){const{channelData:e,segments:i,samplingQuality:n}=t.data,s=[],a=Math.floor(e.length/i),o=function(t,e,i){const n=Math.floor(t/i);switch(e){case"low":return Math.max(1,Math.floor(n/5));case"medium":default:return Math.max(1,Math.floor(n/10));case"high":return Math.max(1,Math.floor(n/20))}}(e.length,n,i);for(let t=0;t<i;t+=50){const n=Math.min(t+50,i),r=[];for(let i=t;i<n;i++){const t=i*a,n=Math.min(t+a,e.length);let s=0,h=0;for(let i=t;i<n;i+=o)s+=Math.abs(e[i]),h++;const d=s/h;r.push(d)}const h=Math.round(n/i*100);self.postMessage({type:"progress",progress:h}),s.push(...r)}const r=60/Math.max(...s),h=s.map((t=>10+t*r));self.postMessage({type:"complete",data:h})}},i=function(e,n){this.settings=t.extend({},i.defaults,n),this.element=t(e),this.audioElement=t(this.settings.audioElement)[0],this.audioContext=this.settings.audioContext,this.isDragging=!1,this.tempProgress=0,this.segments=[],this.waveformData=null,this.interactionEnabled=!1,this.init()};i.defaults={audioElement:"#audio-element",audioContext:null,segments:100,segmentGap:1,activeColor:"#2196F3",inactiveColor:"#ccc",backgroundColor:"#f5f5f5",rtl:!1,onRendered:null,onProgressChange:null,onSeek:null,samplingQuality:"medium",loadingText:"Loading waveform..."},i.prototype={init:function(){this.audioContext?(this.createContainer(),this.bindEvents(),this.disableInteraction(),this.addLoadingIndicator(),t(this.audioElement).one("loadedmetadata",(()=>{this.audioElement.duration&&!isNaN(this.audioElement.duration)&&(this.enableInteraction(),this.removeLoadingIndicator())}))):console.error("AudioContext is required")},addLoadingIndicator:function(){if(0===this.element.find(".waveform-loading-indicator").length){this.loadingIndicator=t("<div>").addClass("waveform-loading-indicator").css({position:"absolute",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(0,0,0,0.05)",borderRadius:"18px",display:"flex",justifyContent:"center",alignItems:"center",zIndex:"10"});const e=t("<span>").html(this.settings.loadingText).css({fontSize:"10px",color:"#666",opacity:"0.7"});this.loadingIndicator.append(e),this.element.append(this.loadingIndicator)}},removeLoadingIndicator:function(){this.loadingIndicator&&this.loadingIndicator.fadeOut(300,(function(){t(this).remove()}))},disableInteraction:function(){this.interactionEnabled=!1,this.element.css("cursor","not-allowed")},enableInteraction:function(){this.interactionEnabled=!0,this.element.css("cursor","pointer")},createContainer:function(){this.element.addClass("waveform-container").css({position:"relative",height:"36px",background:"#f5f5f5",borderRadius:"18px",overflow:"hidden",cursor:"pointer",touchAction:"none",flexGrow:1,userSelect:"none",msUserSelect:"none",mozUserSelect:"none",WebkitUserDrag:"none",WebkitUserSelect:"none",WebkitTapHighlightColor:"transparent"});const e=this.settings.rtl?{direction:"rtl",flexDirection:"row-reverse"}:{direction:"ltr",flexDirection:"row"};this.waveform=t("<div>").addClass("waveform").css({position:"absolute",top:"0",left:"0",width:"100%",height:"100%",display:"flex",alignItems:"center",padding:"0 12px",boxSizing:"border-box",...e}),this.element.append(this.waveform)},async loadAudioData(t){try{this.addLoadingIndicator();const i=await this.audioContext.decodeAudioData(t),n=Array.from(i.getChannelData(0)),s=(t=>{const e=t.toString(),i=new Blob([`(${e})()`],{type:"application/javascript"}),n=URL.createObjectURL(i),s=new Worker(n);return URL.revokeObjectURL(n),s})(e);return new Promise(((t,e)=>{s.onmessage=e=>{const{type:i,data:n,progress:a}=e.data;if("progress"===i){this.element.find(".waveform-loading-indicator span").html(`${this.settings.loadingText} ${a}%`)}else"complete"===i&&(this.waveformData=n,this.removeLoadingIndicator(),this.generateSegments(),this.audioElement.duration&&!isNaN(this.audioElement.duration)&&this.enableInteraction(),s.terminate(),t())},s.onerror=t=>{console.error("Worker error:",t),s.terminate(),e(t)},s.postMessage({channelData:n,segments:this.settings.segments,samplingQuality:this.settings.samplingQuality})}))}catch(t){throw console.error("Error processing audio data:",t),this.handleError(),t}},generateSegments:function(){if(!this.waveformData)return;this.waveform.empty();const e=document.createDocumentFragment();this.segments=[];const i=this.waveformData.length;let n=0;const s=()=>{const a=50*n,o=Math.min(a+50,i);for(let n=a;n<o;n++){const s=this.waveformData[this.settings.rtl?i-1-n:n],a=t("<div>").css({flex:"1",margin:`0 ${this.settings.segmentGap}px`,height:s+"%",position:"relative",borderRadius:"1px",overflow:"hidden"})[0],o=t("<div>").css({position:"absolute",top:"0",left:"0",width:"100%",height:"100%",background:this.settings.inactiveColor}).addClass("segment")[0],r=t("<div>").css({position:"absolute",top:"0",height:"100%",background:this.settings.activeColor,[this.settings.rtl?"right":"left"]:"0",[this.settings.rtl?"left":"right"]:"auto",width:"0%"}).addClass("fill")[0];a.appendChild(o),a.appendChild(r),this.segments.push(t(a)),e.appendChild(a)}o<i?(n++,requestAnimationFrame(s)):(this.waveform[0].appendChild(e),this.settings.onRendered&&this.settings.onRendered(this),this.audioElement.duration&&!isNaN(this.audioElement.duration)&&(this.enableInteraction(),this.removeLoadingIndicator()))};requestAnimationFrame(s)},updateProgress:function(t){if(!this.segments.length)return;const e=t*this.segments.length,i=Math.floor(e),n=100*(e-i);if(this.settings.rtl)for(let t=0;t<this.segments.length;t++){const e=this.segments[t].children().last();t>=this.segments.length-i?e.css("width","100%"):t===this.segments.length-i-1?e.css("width",`${n}%`):e.css("width","0%")}else this.segments.forEach(((t,e)=>{const s=t.children().last();e<i?s.css("width","100%"):e===i?s.css("width",`${n}%`):s.css("width","0%")}))},bindEvents:function(){t(this.audioElement).on("loadeddata",(()=>{this.audioElement.src&&!this.waveformData&&(this.disableInteraction(),this.addLoadingIndicator(),fetch(this.audioElement.src).then((t=>t.arrayBuffer())).then((t=>this.loadAudioData(t))))})),t(this.audioElement).on("emptied",(()=>{this.disableInteraction(),this.addLoadingIndicator()})),t(this.audioElement).on("timeupdate",(()=>{if(!this.isDragging&&this.audioElement.duration&&!isNaN(this.audioElement.duration)){const t=this.audioElement.currentTime/this.audioElement.duration;this.updateProgress(t),this.settings.onProgressChange&&this.settings.onProgressChange(t)}})),this.element.on("mousedown touchstart",(t=>this.handleStart(t))).on("mousemove touchmove",(t=>this.handleMove(t))).on("mouseup mouseleave touchend",(t=>this.handleEnd(t)))},handleStart:function(t){if(t.preventDefault(),t.stopPropagation(),!this.interactionEnabled||!this.audioElement.duration||isNaN(this.audioElement.duration))return;this.isDragging=!0;const e=t.type.includes("mouse")?t.clientX:t.touches[0].clientX;this.updateVisualProgress(e)},handleMove:function(t){if(t.preventDefault(),t.stopPropagation(),!this.isDragging||!this.interactionEnabled)return;const e=t.type.includes("mouse")?t.clientX:t.touches[0].clientX;this.updateVisualProgress(e)},handleEnd:function(t){t.preventDefault(),t.stopPropagation(),this.isDragging&&this.interactionEnabled&&(this.isDragging=!1,this.settings.onSeek&&this.audioElement.duration&&!isNaN(this.audioElement.duration)&&this.settings.onSeek(this.tempProgress))},updateVisualProgress:function(t){const e=this.element[0].getBoundingClientRect();let i;i=this.settings.rtl?Math.max(0,Math.min(1,1-(t-e.left)/e.width)):Math.max(0,Math.min(1,(t-e.left)/e.width)),this.tempProgress=i,this.updateProgress(this.tempProgress),this.settings.onProgressChange&&this.audioElement&&this.audioElement.duration&&!isNaN(this.audioElement.duration)&&this.settings.onProgressChange(this.tempProgress)},export:function(){return this.waveformData?{version:"2.2.0",data:this.waveformData,settings:{samplingQuality:this.settings.samplingQuality,rtl:this.settings.rtl}}:(console.warn("No waveform data available to export"),null)},restore:function(t){if(!t||!t.data||!Array.isArray(t.data))return console.error("Invalid waveform data format"),!1;try{return this.waveformData=t.data,t.settings&&(t.settings.samplingQuality&&(this.settings.samplingQuality=t.settings.samplingQuality),void 0!==t.settings.rtl&&(this.settings.rtl=t.settings.rtl)),this.generateSegments(),!0}catch(t){return console.error("Error restoring waveform data:",t),!1}},destroy:function(){this.element.off(),this.waveform.remove(),this.element.removeData("waveform")}},t.fn.waveform=function(e){return this.each((function(){t.data(this,"waveform")||t.data(this,"waveform",new i(this,e))}))}}(jQuery);
